<view-heading
  [title]="'purchase-and-orders.price-estimate.info' | translate"
  [icon]="'Box_Add'"
/>
<ng-container [formGroup]="formGroup" *ngIf="priceEstimate">
  <section>
    <div class="row">
      <div class="col s12 l4">
        <label class="cl-input-label cl-required">{{
          'purchase-and-orders.price-estimate.date' | translate
        }}</label>
        <cl-date-picker
          [placeholder]="'select-date' | translate"
          formControlName="date"
          clValidatorErrors
          [showValidatorErrors]="
            formGroup.controls['date'].touched &&
            !!formGroup.controls['date'].errors
          "
        />
      </div>
      <div class="col s12 l4">
        <label class="cl-input-label">{{
          'base-data.system-code' | translate
        }}</label>
        <cl-input-text formControlName="autoGeneratedCode" readonly />
      </div>
    </div>
  </section>

  <view-heading
    [title]="
      'purchase-and-orders.price-estimate.goods-service-list' | translate
    "
    [icon]="'Takeout_Dining'"
  />

  <cl-data-table
    [scrollVertical]="true"
    [value]="priceEstimate.priceEstimateItems!"
  >
    <ng-template clTemplate="header">
      <tr>
        <th>{{ 'base-data.goods.code' | translate }}</th>
        <th>{{ 'base-data.goods.description' | translate }}</th>
        <th>{{ 'amount' | translate }}</th>
        <th>
          {{
            'purchase-and-orders.price-estimate.estimated-unit-amount'
              | translate
          }}
        </th>
        <th>
          {{ 'purchase-and-orders.price-estimate.tax-percentage' | translate }}
        </th>
        <th>
          {{
            'purchase-and-orders.price-estimate.additional-expenses' | translate
          }}
        </th>
        <th>
          {{ 'purchase-and-orders.price-estimate.description' | translate }}
        </th>
      </tr>
    </ng-template>

    <ng-container formArrayName="priceEstimateItems">
      <ng-template clTemplate="body" let-row="row" let-index="index">
        <tr [formGroupName]="index">
          <td>{{ priceEstimateItems.at(index).get('goods')?.value.code }}</td>
          <td>{{ priceEstimateItems.at(index).get('goods')?.value.label }}</td>
          <td>
            {{
              priceEstimateItems.at(index).get('goods')?.value.remainingQuantity
            }}
          </td>
          <td>
            <cl-input-number
              [useGrouping]="true"
              [suffix]="'currency.rial' | translate"
              formControlName="estimateFee"
            />
          </td>
          <td>
            <cl-input-number prefix="%" formControlName="taxPercent" />
          </td>
          <td>
            <cl-input-number
              [useGrouping]="true"
              [suffix]="'currency.rial' | translate"
              formControlName="deductionsAmount"
            />
          </td>
          <td>
            <cl-input-text formControlName="description" />
          </td>
        </tr>
      </ng-template>
    </ng-container>
  </cl-data-table>
</ng-container>
<div
  [formGroup]="totalPriceForm"
  *ngIf="priceEstimate"
  class="row top-margin total-price"
>
  <div class="col s12 l4 pull-l8">
    <label class="cl-input-label">{{
      'purchase-and-orders.price-estimate.total-amount' | translate
    }}</label>
    <cl-input-number
      [useGrouping]="true"
      [suffix]="'currency.rial' | translate"
      formControlName="totalPrice"
      readonly
    />
  </div>
  <div class="row price-estimate-attachments">
    <div class="col s12 cl-form-field">
      <view-heading
        [title]="'attachments.upload' | translate"
        [icon]="'attach_file'"
      />
      <cl-file-uploader
        formControlName="attachedFiles"
        fileBtnType="info"
        [auto]="false"
        [customUpload]="true"
        [accept]="appFacade.appStore.state$().fileAttachmentConfig$().fileType"
        [maxFileSize]="
          appFacade.appStore.state$().fileAttachmentConfig$().maxUploadSize
        "
        [fileLimit]="
          appFacade.appStore.state$().fileAttachmentConfig$()
            .maximumNumberOfFile
        "
        [deleteConfirmDialogConfig]="confirmationConfig"
        [fileDeleteUrl]="
          'price-estimate-document/deleteFile/' +
          formGroup.get('autoGeneratedCode')?.value +
          '?' +
          deleteFileHttpParams()
        "
        (onFileActionMenuOpen)="deleteAttachment($event)"
        clValidatorErrors
        [showValidatorErrors]="
          !!totalPriceForm.controls['attachedFiles'].errors
        "
      />
    </div>
  </div>
</div>
